package pnpiot.serializationperf;

import java.io.PrintWriter;
import java.lang.management.ManagementFactory;
import java.lang.management.OperatingSystemMXBean;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;

import com.fasterxml.jackson.databind.ObjectMapper;

public class JsonApp {
	static String jsonStringInput = "{\"timeStamp\":101,\"fixType\":102,\"latitude\":400,\"longitude\":500,\"heading\":300,\"altitude\":100,\"speed\":255}";

	public static void main(String[] args) throws Exception {
		long loops = 1000; // default is 1 million loops
		if (args.length > 0) {
			loops = Math.abs(Integer.parseInt(args[0])) * 1000;
		}
		ObjectMapper mapper = new ObjectMapper();
		Location jsonObject = mapper.readValue(jsonStringInput, Location.class);
		long startTime = System.currentTimeMillis();
		for (int i = 0; i < loops; i++) {
			for (int j = 0; j < 1000; j++) {
				mapper.writeValueAsString(jsonObject);
			}
		}
		long elapsedTime = System.currentTimeMillis() - startTime;
		printResult(loops, elapsedTime);
	}

	private static void printResult(long loops, long elapsedTime) throws Exception {
		String filePath = System.getProperty("user.dir") + "\\jsonjackson.txt";
		PrintWriter writer = new PrintWriter(filePath, "UTF-8");

		System.out.println("JsonJacksonApp Result");
		writer.println("JsonJacksonApp Result");

		System.out.println("Number of Iterations = " + loops);
		writer.println("Number of Iterations = " + loops);

		System.out.println("Mini seconds elapsed = " + elapsedTime);
		writer.println("Mini seconds elapsed = " + elapsedTime);

		OperatingSystemMXBean operatingSystemMXBean = ManagementFactory.getOperatingSystemMXBean();
		for (Method method : operatingSystemMXBean.getClass().getDeclaredMethods()) {
			method.setAccessible(true);
			if (method.getName().startsWith("get") && Modifier.isPublic(method.getModifiers())) {
				Object value = method.invoke(operatingSystemMXBean);
				System.out.println(method.getName().substring(3) + " = " + value);
				writer.println(method.getName().substring(3) + " = " + value);
			}
		}
		writer.close();
	}
}

// To generate the jar files with dependencies
// In Eclipse, File->Export->Java->Runnable Jar File
// Set destination as JsonJackson\JsonJackson.jar

// To run the jar files in Command Prompt
// Start Command Prompt as admin
// java -jar jsonjackson.jar 20
// open jsonjackson.txt in the current working folder

// To run the jar files in PowerShell
// Start PowerShell as admin
// &"C:\Program Files\Java\jdk1.8.0_05\bin\java.exe" -jar jsonjackson.jar 20
// open jsonjackson.txt in the current working folder

// To use measure-command
// Start PowerShell as admin
// measure-command { &"C:\Program Files\Java\jdk1.8.0_05\bin\java.exe" -jar jsonjackson.jar 20}
// open jsonjackson.txt in the current working folder
